<!DOCTYPE html>
<html lang="es">
<head>
Â  <meta charset="UTF-8" />
Â  <title>Papoclub â€¢ PapoClub Chat</title>
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

Â  Â  <meta name="mobile-web-app-capable" content="yes">
Â  <meta name="apple-mobile-web-app-capable" content="yes">
Â  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
Â  <meta name="apple-mobile-web-app-title" content="Papoclub">
Â  <meta name="theme-color" content="#00917a">
Â  <link rel="manifest" href="manifest.json">
Â  <link rel="apple-touch-icon" href="icon-192.png">

Â  <style>
Â  Â  :root{--bg1:#006994;--bg2:#00b88a;--ink:#0ff;--card:rgba(0,0,0,.18);--ink2:#002f36}
Â  Â  *{box-sizing:border-box}
Â  Â  html,body{height:100%}
Â  Â  body{
Â  Â  Â  margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
Â  Â  Â  background: linear-gradient(135deg, var(--bg1), var(--bg2));
Â  Â  Â  color: var(--ink); display:flex; flex-direction:column;
Â  Â  }
Â  Â  header{
Â  Â  Â  position: sticky; top:0; z-index:10; backdrop-filter: blur(6px);
Â  Â  Â  background: linear-gradient(145deg, #00e5ff55, #0099cc55);
Â  Â  Â  border-bottom: 1px solid #00e5ff44; padding: 12px 16px; display:flex; align-items:center; gap:12px;
Â  Â  }
Â  Â  header img{width:32px;height:32px;border-radius:50%; box-shadow:0 0 0 2px #00e5ff66}
Â  Â  header .grow{flex:1}
Â  Â  header .btn{background:#00e5ff;color:#003;border:none;padding:8px 14px;border-radius:12px;font-weight:700;cursor:pointer}
Â  Â  header .btn:hover{filter:brightness(0.95)}

Â  Â  main{flex:1; display:flex; flex-direction:column; gap:12px; padding:12px;}

Â  Â  .card{background:var(--card); border-radius:16px; box-shadow:0 0 10px #00e5ff55; padding:12px; max-width:840px; width:100%; margin:0 auto}

Â  Â  .status{display:flex; align-items:center; gap:10px}
Â  Â  .status .dot{width:10px;height:10px;border-radius:50%; background:#f55}
Â  Â  .status.auth .dot{background:#4dff88}

Â  Â  /* Chat */
Â  Â  .chat-historial{flex:1; overflow-y:auto; max-height:58vh}
Â  Â  #mensajes{display:flex; flex-direction:column; gap:12px}
Â  Â  .msg{background:rgba(0,0,0,.3); border-radius:14px; padding:10px; box-shadow:0 0 6px #00e5ff44}
Â  Â  .msg .meta{font-size:.8em; color:#cde; opacity:.9; display:flex; align-items:center; gap:8px}
Â  Â  .msg img{width:22px;height:22px;border-radius:50%; vertical-align:middle}
Â  Â  .msg .texto{white-space:pre-wrap; word-wrap:break-word; color:#eaffff}

Â  Â  .chat-input{display:grid; grid-template-columns:1fr auto; gap:8px}
Â  Â  textarea{width:100%; min-height:44px; max-height:120px; resize:vertical; border:none; border-radius:12px; padding:10px; background:var(--ink2); color:var(--ink)}
Â  Â  button.send{background:#00e5ff; color:#003; border:none; padding:10px 18px; border-radius:12px; font-weight:800; cursor:pointer}
Â  Â  button.send:disabled{background:#678; color:#aac; cursor:not-allowed}
Â  Â  .help{font-size:.9em; opacity:.9}

Â  Â  .hidden{display:none !important}
Â  </style>
</head>
<body>
Â  <header>
Â  Â  <strong>ðŸ’¬ Papotokens â€¢ Chat PÃºblico</strong>
Â  Â  <span class="grow"></span>
Â  Â  <div id="user-slot" class="status"><span class="dot"></span><span>Desconectado</span></div>
Â  Â  <button id="btnLogin" class="btn">Iniciar sesiÃ³n</button>
Â  Â  <button id="btnLogout" class="btn hidden">Salir</button>
Â  </header>

Â  <main>
Â  Â  Â  Â  <section class="card">
Â  Â  Â  <div class="help">
Â  Â  Â  Â  <p><strong>Nota:</strong> Para ver y enviar mensajes necesitas iniciar sesiÃ³n. Una vez instalado como app (PWA), se abrirÃ¡ en modo pantalla completa.</p>
Â  Â  Â  </div>
Â  Â  </section>

Â  Â  Â  Â  <section class="card">
Â  Â  Â  <h3 style="margin-top:0">Sala: pÃºblico</h3>
Â  Â  Â  <div class="chat-historial card" style="margin:8px 0">
Â  Â  Â  Â  <div id="mensajes"><div class="help">Cargando mensajesâ€¦</div></div>
Â  Â  Â  </div>
Â  Â  Â  <div class="chat-input">
Â  Â  Â  Â  <textarea id="msg" placeholder="Escribe un mensajeâ€¦" disabled></textarea>
Â  Â  Â  Â  <button id="btnSend" class="send" disabled>Enviar</button>
Â  Â  Â  </div>
Â  Â  Â  <div class="help">Antiâ€‘spam: espera 2s entre envÃ­os. URLs bloqueadas para no-admin.</div>
Â  Â  </section>
Â  </main>

Â  <script type="module">
Â  Â  // Firebase v10 modular
Â  Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
Â  Â  import {
Â  Â  Â  getFirestore, collection, addDoc, onSnapshot, query, orderBy,
Â  Â  Â  doc, getDoc, setDoc, serverTimestamp, enableIndexedDbPersistence
Â  Â  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
Â  Â  import {
Â  Â  Â  getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut
Â  Â  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

Â  Â  // Config de tu proyecto Papoclub
Â  Â  const firebaseConfig = {
Â  Â  Â  apiKey: "AIzaSyCJmOS9MjDhjJrKCMIUVbgmRiEi2xLIkrQ",
Â  Â  Â  authDomain: "papoclub-737ac.firebaseapp.com",
Â  Â  Â  projectId: "papoclub-737ac",
Â  Â  Â  storageBucket: "papoclub-737ac.appspot.com",
Â  Â  Â  messagingSenderId: "76712370993",
Â  Â  Â  appId: "1:76712370993:web:2d2646b258efbccf68c73e"
Â  Â  };

Â  Â  const app = initializeApp(firebaseConfig);
Â  Â  const db = getFirestore(app);
Â  Â  const auth = getAuth(app);

Â  Â  // Habilitar cachÃ© offline para lecturas (opcional)
Â  Â  enableIndexedDbPersistence(db).catch(() => {/* puede fallar en incÃ³gnito */});

Â  Â  // UI refs
Â  Â  const btnLogin = document.getElementById('btnLogin');
Â  Â  const btnLogout = document.getElementById('btnLogout');
Â  Â  const userSlot = document.getElementById('user-slot');
Â  Â  const mensajesEl = document.getElementById('mensajes');
Â  Â  const msg = document.getElementById('msg');
Â  Â  const btnSend = document.getElementById('btnSend');

Â  Â  let currentUser = null;
Â  Â  let sending = false;

Â  Â  // Auth state
Â  Â  onAuthStateChanged(auth, async (user) => {
Â  Â  Â  currentUser = user || null;

Â  Â  Â  if (user) {
Â  Â  Â  Â  // UI
Â  Â  Â  Â  userSlot.classList.add('auth');
Â  Â  Â  Â  userSlot.innerHTML = `<span class="dot"></span><img src="${user.photoURL || 'https://via.placeholder.com/32?text=%F0%9F%91%A4'}" alt="avatar"/> <span>${user.displayName || user.email}</span>`;
Â  Â  Â  Â  btnLogin.classList.add('hidden');
Â  Â  Â  Â  btnLogout.classList.remove('hidden');
Â  Â  Â  Â  msg.disabled = false; btnSend.disabled = false;

Â  Â  Â  Â  // Asegurar doc de perfil mÃ­nimo para reglas de chat
Â  Â  Â  Â  const uref = doc(db, 'users', user.uid);
Â  Â  Â  Â  const snap = await getDoc(uref);
Â  Â  Â  Â  const defaultNick = (user.displayName?.trim()) || (user.email?.split('@')[0]) || 'user';
Â  Â  Â  Â  const defaultAvatar = user.photoURL || 'https://via.placeholder.com/30?text=%F0%9F%91%A4';
Â  Â  Â  Â  if (!snap.exists()) {
Â  Â  Â  Â  Â  await setDoc(uref, { nick: defaultNick, avatar: defaultAvatar });
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  // Si faltan campos requeridos por reglas, complÃ©talos
Â  Â  Â  Â  Â  const d = snap.data();
Â  Â  Â  Â  Â  const patch = {};
Â  Â  Â  Â  Â  if (!d.nick) patch.nick = defaultNick;
Â  Â  Â  Â  Â  if (!d.avatar) patch.avatar = defaultAvatar;
Â  Â  Â  Â  Â  if (Object.keys(patch).length) await setDoc(uref, { ...d, ...patch });
Â  Â  Â  Â  }
Â  Â  Â  } else {
Â  Â  Â  Â  userSlot.classList.remove('auth');
Â  Â  Â  Â  userSlot.innerHTML = '<span class="dot"></span><span>Desconectado</span>';
Â  Â  Â  Â  btnLogin.classList.remove('hidden');
Â  Â  Â  Â  btnLogout.classList.add('hidden');
Â  Â  Â  Â  msg.value = '';
Â  Â  Â  Â  msg.disabled = true; btnSend.disabled = true;
Â  Â  Â  }
Â  Â  });

Â  Â  // Login/Logout handlers
Â  Â  btnLogin.addEventListener('click', async () => {
Â  Â  Â  try {
Â  Â  Â  Â  const provider = new GoogleAuthProvider();
Â  Â  Â  Â  await signInWithPopup(auth, provider);
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  alert('No se pudo iniciar sesiÃ³n: ' + e.message);
Â  Â  Â  }
Â  Â  });
Â  Â  btnLogout.addEventListener('click', async () => {
Â  Â  Â  await signOut(auth);
Â  Â  });

Â  Â  // Escuchar mensajes pÃºblicos en tiempo real
Â  Â  const q = query(collection(db, 'chatPublico'), orderBy('fecha', 'asc'));
Â  Â  onSnapshot(q, (snap) => {
Â  Â  Â  if (snap.empty) {
Â  Â  Â  Â  mensajesEl.innerHTML = '<div class="help">No hay mensajes todavÃ­aâ€¦ Â¡sÃ© el primero!</div>';
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  mensajesEl.innerHTML = '';
Â  Â  Â  snap.forEach(docu => {
Â  Â  Â  Â  const m = docu.data();
Â  Â  Â  Â  // fecha
Â  Â  Â  Â  let f = 'Ahora';
Â  Â  Â  Â  if (m.fecha?.seconds) f = new Date(m.fecha.seconds * 1000).toLocaleString();
Â  Â  Â  Â  else if (m.fecha?.toDate) f = m.fecha.toDate().toLocaleString();

Â  Â  Â  Â  // nodo
Â  Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  Â  div.className = 'msg';
Â  Â  Â  Â  div.innerHTML = `
Â  Â  Â  Â  Â  <div class="meta">
Â  Â  Â  Â  Â  Â  <img src="${m.avatar || 'https://via.placeholder.com/22?text=%F0%9F%91%A4'}" onerror="this.src='https://via.placeholder.com/22?text=%F0%9F%91%A4'"/>
Â  Â  Â  Â  Â  Â  <strong>@${(m.nick || 'user')}</strong>
Â  Â  Â  Â  Â  Â  <span>â€¢ ${f}</span>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="texto"></div>
Â  Â  Â  Â  `;
Â  Â  Â  Â  div.querySelector('.texto').textContent = m.texto || '';
Â  Â  Â  Â  mensajesEl.appendChild(div);
Â  Â  Â  });
Â  Â  Â  // scroll al final si es necesario
Â  Â  Â  mensajesEl.parentElement.scrollTop = mensajesEl.parentElement.scrollHeight;
Â  Â  }, (err) => {
Â  Â  Â  mensajesEl.innerHTML = `<div class="help">Error cargando mensajes: ${err.message}</div>`;
Â  Â  });

Â  Â  // Enviar mensaje
Â  Â  async function enviar(){
Â  Â  Â  const texto = msg.value.trim();
Â  Â  Â  if (!currentUser) { alert('Inicia sesiÃ³n para enviar.'); return; }
Â  Â  Â  if (!texto || sending) return;

Â  Â  Â  // anti-URL para todos excepto admin
Â  Â  Â  if (currentUser.email !== 'borincano@gmail.com' && /https?:\/\//i.test(texto)) {
Â  Â  Â  Â  msg.value = '';
Â  Â  Â  Â  alert('Mensaje con URL no permitido');
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  try {
Â  Â  Â  Â  sending = true; btnSend.disabled = true;
Â  Â  Â  Â  // obtener perfil
Â  Â  Â  Â  const uref = doc(db, 'users', currentUser.uid);
Â  Â  Â  Â  const s = await getDoc(uref);
Â  Â  Â  Â  const perfil = s.exists() ? s.data() : {};
Â  Â  Â  Â  const nick = perfil.nick || currentUser.displayName || currentUser.email.split('@')[0];
Â  Â  Â  Â  const avatar = perfil.avatar || currentUser.photoURL || 'https://via.placeholder.com/30?text=%F0%9F%91%A4';

Â  Â  Â  Â  await addDoc(collection(db, 'chatPublico'), {
Â  Â  Â  Â  Â  texto, uid: currentUser.uid, nick, avatar, fecha: serverTimestamp()
Â  Â  Â  Â  });

Â  Â  Â  Â  // Esta es la lÃ­nea que borra el texto del campo de entrada.
Â  Â  Â  Â  msg.value = '';
Â  Â  Â  } catch(e){
Â  Â  Â  Â  alert('No se pudo enviar: '+ e.message);
Â  Â  Â  } finally {
Â  Â  Â  Â  // cooldown 2s
Â  Â  Â  Â  setTimeout(()=>{ sending=false; btnSend.disabled=false; }, 2000);
Â  Â  Â  }
Â  Â  }

Â  Â  btnSend.addEventListener('click', enviar);
Â  Â  msg.addEventListener('keydown', (e)=>{
Â  Â  Â  if (e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); enviar(); }
Â  Â  });

Â  Â  // Registrar Service Worker para PWA
Â  Â  if ('serviceWorker' in navigator){
Â  Â  Â  navigator.serviceWorker.register('/sw.js').catch(()=>{});
Â  Â  }
Â  </script>
</body>
</html>
